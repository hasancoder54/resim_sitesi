<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImgBB YÃ¼kleyici (Vercel + Firestore)</title>
    
    <link rel="stylesheet" href="/style.css">
    
    <!-- Firebase SDK YÃ¼klemeleri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, deleteDoc, setDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Firebase log seviyesini ayarla (hata ayÄ±klama iÃ§in)
        setLogLevel('debug');
        
        // --- Global DeÄŸiÅŸkenler ve KonfigÃ¼rasyon ---
        
        // Firebase global deÄŸiÅŸkenlerini al
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Uygulama ayarlarÄ±
        const CORRECT_PASSWORD = 'Admin51423';
        const FIRESTORE_COLLECTION_NAME = 'imgbb_uploads';
        
        // --- DOM Elementleri ---
        const loginSection = document.getElementById('login-section');
        const uploadSection = document.getElementById('upload-section');
        const historySection = document.getElementById('history-section');
        const loginMessage = document.getElementById('login-message');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const uploadForm = document.getElementById('upload-form');
        const uploadMessage = document.getElementById('upload-message');
        const imageGrid = document.getElementById('image-grid');

        function setDisplay(element, isVisible) {
            element.classList.toggle('hidden', !isVisible);
        }

        function updateMessage(type, content) {
            uploadMessage.className = `message ${type}`;
            uploadMessage.textContent = content;
            setDisplay(uploadMessage, true);
        }

        // --- 1. FIREBASE BAÅLATMA VE YETKÄ°LENDÄ°RME ---

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Ã–zel Auth Token ile giriÅŸ yap veya anonim giriÅŸ yap
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Auth durumu deÄŸiÅŸtiÄŸinde (giriÅŸ yapÄ±ldÄ±ÄŸÄ±nda)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth BaÅŸarÄ±lÄ±. User ID:", userId);
                        
                        if (localStorage.getItem('isAuthenticated') === 'true') {
                            // BaÅŸarÄ±lÄ± giriÅŸi takiben verileri yÃ¼kle
                            loadHistoryListener();
                            setDisplay(loginSection, false);
                            setDisplay(uploadSection, true);
                            setDisplay(historySection, true);
                        }
                    } else {
                        userId = null;
                        isAuthReady = false;
                        console.log("Firebase Auth HazÄ±r DeÄŸil.");
                    }
                });

            } catch (error) {
                console.error("Firebase BaÅŸlatma HatasÄ±:", error);
                updateMessage('error', 'VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±.');
            }
        }
        
        // --- 2. GÄ°RÄ°Å KONTROLÃœ ---
        
        function checkPassword() {
            const enteredPassword = passwordInput.value;
            if (enteredPassword === CORRECT_PASSWORD) {
                // BaÅŸarÄ±lÄ± giriÅŸ
                localStorage.setItem('isAuthenticated', 'true');
                setDisplay(loginMessage, false);
                passwordInput.value = '';
                
                // Auth zaten hazÄ±rsa doÄŸrudan gÃ¶ster ve verileri yÃ¼kle
                if (isAuthReady) {
                    setDisplay(loginSection, false);
                    setDisplay(uploadSection, true);
                    setDisplay(historySection, true);
                    loadHistoryListener();
                }
            } else {
                // BaÅŸarÄ±sÄ±z giriÅŸ
                setDisplay(loginMessage, true);
                loginMessage.textContent = 'YanlÄ±ÅŸ ÅŸifre. Tekrar deneyin.';
                passwordInput.value = '';
            }
        }

        // GiriÅŸ Butonu OlayÄ±
        loginButton.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // Sayfa YÃ¼klenince Åifre Durumunu Kontrol Et
        if (localStorage.getItem('isAuthenticated') === 'true') {
            // Åifre doÄŸruysa, Firebase hazÄ±r olana kadar bekle (UI geÃ§iÅŸini AuthListener yapacak)
            setDisplay(loginSection, false);
        } else {
            // Åifre yanlÄ±ÅŸsa veya yoksa giriÅŸ ekranÄ±nÄ± gÃ¶ster
            setDisplay(loginSection, true);
            setDisplay(uploadSection, false);
            setDisplay(historySection, false);
        }

        // --- 3. FIRESTORE Ä°ÅLEMLERÄ° (OKUMA VE GÃ–RÃœNTÃœLEME) ---
        
        function getCollectionRef() {
            // Herkesin gÃ¶rebileceÄŸi ortak alan: /artifacts/{appId}/public/data/imgbb_uploads
            return collection(db, `artifacts/${appId}/public/data/${FIRESTORE_COLLECTION_NAME}`);
        }
        
        function renderImages(images) {
            imageGrid.innerHTML = ''; 
            
            if (images.length === 0) {
                imageGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">HenÃ¼z yÃ¼klenmiÅŸ gÃ¶rsel yok.</p>';
                return;
            }

            images.forEach(img => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.dataset.id = img.id;
                
                // Firestore serverTimestamp dÃ¶ndÃ¼ÄŸÃ¼ iÃ§in 'tarih' nesnesini doÄŸru okuyoruz
                const dateString = img.tarih?.seconds ? new Date(img.tarih.seconds * 1000).toLocaleString() : 'Tarih Yok';

                item.innerHTML = `
                    <img src="${img.link}" alt="${img.dosya_adi}" loading="lazy" class="uploaded-image">
                    <div class="image-info">
                        <p>ğŸ”— <a href="${img.link}" target="_blank" class="link-text">Link Kopyala</a></p>
                        <p class="filename">${img.dosya_adi} (${Math.round(img.boyut / 1024)} KB)</p>
                        <p class="date">${dateString}</p>
                    </div>
                    <button class="delete-button" data-id="${img.id}">GeÃ§miÅŸten KaldÄ±r</button>
                `;
                imageGrid.appendChild(item);
            });
        }
        
        function loadHistoryListener() {
            if (!isAuthReady || localStorage.getItem('isAuthenticated') !== 'true') return;
            
            // TÃ¼m gÃ¶rselleri Ã§ek
            const imagesQuery = query(getCollectionRef());

            onSnapshot(imagesQuery, (snapshot) => {
                const images = [];
                snapshot.forEach(doc => {
                    images.push({ id: doc.id, ...doc.data() });
                });
                
                // Tarihe gÃ¶re sÄ±ralama (en yeni baÅŸa)
                images.sort((a, b) => (b.tarih?.seconds || 0) - (a.tarih?.seconds || 0));

                renderImages(images);
                document.getElementById('history-title').textContent = `YÃ¼klenen GÃ¶rseller (${images.length})`;
            }, (error) => {
                console.error("Firestore Dinleme HatasÄ±:", error);
                updateMessage('error', 'GÃ¶rsel geÃ§miÅŸi yÃ¼klenemedi.');
            });
        }

        // --- 4. GÃ–RSEL YÃœKLEME VE KAYDETME Ä°ÅLEMLERÄ° ---
        
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady || localStorage.getItem('isAuthenticated') !== 'true') {
                updateMessage('error', 'LÃ¼tfen Ã¶nce ÅŸifre ile giriÅŸ yapÄ±n.');
                return;
            }

            const fileInput = uploadForm.querySelector('input[type="file"]');
            if (fileInput.files.length === 0) {
                updateMessage('error', 'LÃ¼tfen bir gÃ¶rsel seÃ§in.');
                return;
            }

            updateMessage('info', 'â³ GÃ¶rsel yÃ¼kleniyor...');
            
            const file = fileInput.files[0];
            const formData = new FormData(uploadForm);
            
            try {
                // 1. ImgBB'ye YÃ¼kleme (Node.js Serverless Function Ãœzerinden)
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // 2. ImgBB BaÅŸarÄ±lÄ± -> Firestore'a Kaydet
                    await addDoc(getCollectionRef(), {
                        link: data.link,
                        delete_hash: data.delete_hash,
                        dosya_adi: data.fileName,
                        boyut: file.size,
                        yukleyen_id: userId,
                        tarih: serverTimestamp() 
                    });
                    
                    updateMessage('success', `BaÅŸarÄ±lÄ±! Direkt Link: ${data.link}`);
                    fileInput.value = ''; // Formu temizle
                    
                } else {
                    // ImgBB API HatasÄ±
                    updateMessage('error', `YÃ¼kleme BaÅŸarÄ±sÄ±z! Hata: ${data.message}`);
                }
            } catch (error) {
                // AÄŸ veya Sunucu HatasÄ±
                updateMessage('error', `YÃ¼kleme sÄ±rasÄ±nda kritik hata: ${error.message}`);
                console.error('YÃ¼kleme HatasÄ±:', error);
            }
        });
        
        // --- 5. SÄ°LME Ä°ÅLEMÄ° (Firestore'dan KaydÄ± KaldÄ±rÄ±r) ---
        
        imageGrid.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-button')) {
                const docId = e.target.dataset.id;
                
                if (!isAuthReady || !docId) return;

                // UyarÄ± yerine modal kullanÄ±lmasÄ± gerekir ancak burada basitlik iÃ§in confirm kullanÄ±yoruz
                if (!confirm('Bu gÃ¶rseli geÃ§miÅŸten KALICI OLARAK kaldÄ±rmak istediÄŸinizden emin misiniz? (Not: GÃ¶rsel ImgBB Ã¼zerinde kalÄ±r.)')) {
                    return;
                }

                try {
                    const docRef = doc(getCollectionRef(), docId);
                    await deleteDoc(docRef);
                    
                    updateMessage('info', 'GÃ¶rsel geÃ§miÅŸten baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±.');
                } catch (error) {
                    console.error('Silme HatasÄ±:', error);
                    updateMessage('error', 'Silme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu.');
                }
            }
            
            // Link Kopyalama
            if (e.target.classList.contains('link-text')) {
                e.preventDefault();
                const url = e.target.href;
                const tempInput = document.createElement('input');
                tempInput.value = url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('Link panoya kopyalandÄ±: ' + url);
            }
        });
        
        // --- UYGULAMAYI BAÅLAT ---
        initializeFirebase();

    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="highlight">ImgBB</span> GÃ¶rsel YÃ¼kleyici</h1>
            <p class="subtitle">Vercel & Firestore KalÄ±cÄ± GeÃ§miÅŸ</p>
        </header>

        <!-- GiriÅŸ BÃ¶lÃ¼mÃ¼ -->
        <div id="login-section" class="card upload-section hidden">
            <h2>GiriÅŸ YapÄ±n</h2>
            <p id="login-message" class="message error hidden">YanlÄ±ÅŸ ÅŸifre. Tekrar deneyin.</p>
            <input type="password" id="password-input" placeholder="Åifreyi Girin" class="file-input">
            <button id="login-button" class="submit-button">GiriÅŸ</button>
        </div>

        <!-- YÃ¼kleme BÃ¶lÃ¼mÃ¼ (GiriÅŸ YapÄ±ldÄ±ktan Sonra GÃ¶rÃ¼nÃ¼r) -->
        <div id="upload-section" class="card upload-section hidden">
            <h2>GÃ¶rsel YÃ¼kle</h2>
            
            <p id="upload-message" class="message hidden"></p>

            <form id="upload-form">
                <input type="file" name="image_file" accept="image/*" required class="file-input">
                <button type="submit" class="submit-button">YÃ¼kle ve Kaydet</button>
            </form>
        </div>

        <!-- GeÃ§miÅŸ GÃ¶rseller (GiriÅŸ YapÄ±ldÄ±ktan Sonra GÃ¶rÃ¼nÃ¼r) -->
        <div id="history-section" class="card history-section hidden">
            <h2 id="history-title">YÃ¼klenen GÃ¶rseller</h2>
            <div id="image-grid" class="image-grid">
                <!-- GÃ¶rseller buraya JS ile yÃ¼klenecek -->
            </div>
        </div>
    </div>
</body>
</html>

